{{ template "base" . }}

{{ define "content" }}
    <div class="settings-section">
        <h2>系统配置</h2>
        <button class="btn btn-primary" onclick="loadSystemConfig()">
            <i class="fas fa-sync-alt"></i> 刷新配置
        </button>
        <button class="btn btn-success" onclick="showSystemConfigModal()">
            <i class="fas fa-edit"></i> 编辑配置
        </button>

        <div id="config-display" style="margin-top: 20px; padding: 20px; background: #f9fafb; border-radius: 8px;">
            <div style="text-align: center; color: #6b7280;">
                <i class="fas fa-cog" style="font-size: 48px; margin-bottom: 10px;"></i>
                <p>点击"刷新配置"按钮查看当前系统配置</p>
            </div>
        </div>
    </div>

    <div class="settings-section" style="margin-top: 40px;">
        <h2>DNS 供应商管理</h2>
        <button class="btn btn-primary" onclick="showDNSProviderModal()">
            <i class="fas fa-plus"></i> 添加DNS供应商
        </button>

        <div class="table-container" style="margin-top: 20px;">
            <table class="monitors-table">
                <thead>
                    <tr>
                        <th>名称</th>
                        <th>服务器地址</th>
                        <th>协议类型</th>
                        <th>默认</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="dns-providers-tbody">
                    <tr>
                        <td colspan="5" class="loading">加载中...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="settings-section" style="margin-top: 40px;">
        <h2>IP 地理位置查询</h2>
        <div class="ipgeo-form">
            <input type="text" id="ip-input" placeholder="输入 IP 地址 (例如: 8.8.8.8)">
            <button class="btn btn-primary" onclick="queryIPGeo()">
                <i class="fas fa-search"></i> 查询
            </button>
        </div>
        <div id="ipgeo-result" class="ipgeo-result" style="display: none;">
            <div class="ipgeo-info">
                <div class="ipgeo-item">
                    <label>IP 地址:</label>
                    <span id="geo-ip">-</span>
                </div>
                <div class="ipgeo-item">
                    <label>国家:</label>
                    <span id="geo-country">-</span>
                </div>
                <div class="ipgeo-item">
                    <label>地区:</label>
                    <span id="geo-region">-</span>
                </div>
                <div class="ipgeo-item">
                    <label>城市:</label>
                    <span id="geo-city">-</span>
                </div>
                <div class="ipgeo-item">
                    <label>ISP:</label>
                    <span id="geo-isp">-</span>
                </div>
                <div class="ipgeo-item">
                    <label>坐标:</label>
                    <span id="geo-coords">-</span>
                </div>
            </div>
        </div>
    </div>
{{ end }}

{{ define "modals" }}
    <!-- DNS Provider Modal -->
    <div id="dns-provider-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="dns-provider-modal-title">添加DNS供应商</h2>
                <button class="close-btn" onclick="closeDNSProviderModal()">&times;</button>
            </div>
            <form id="dns-provider-form" onsubmit="submitDNSProvider(event)">
                <input type="hidden" id="dns-provider-id">

                <div class="form-section">
                    <h3>DNS供应商信息</h3>
                    <div class="form-group">
                        <label for="dns-provider-name">名称 *</label>
                        <input type="text" id="dns-provider-name" required placeholder="例如: 谷歌DNS">
                        <small>为DNS供应商设置一个友好的名称</small>
                    </div>
                    <div class="form-group">
                        <label for="dns-provider-server">服务器地址 *</label>
                        <input type="text" id="dns-provider-server" required placeholder="例如: 8.8.8.8:53 或 https://dns.google/resolve">
                        <small>DNS服务器地址和端口</small>
                    </div>
                    <div class="form-group">
                        <label for="dns-provider-type">协议类型 *</label>
                        <select id="dns-provider-type" required>
                            <option value="udp">UDP (传统DNS)</option>
                            <option value="tcp">TCP (DNS over TCP)</option>
                            <option value="doh">DoH (DNS over HTTPS)</option>
                            <option value="dot">DoT (DNS over TLS)</option>
                        </select>
                        <small>选择DNS查询协议类型</small>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="dns-provider-default">
                            设为默认供应商
                        </label>
                        <small>标记为默认DNS供应商</small>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeDNSProviderModal()">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- System Config Modal -->
    <div id="system-config-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>系统配置</h2>
                <button class="close-btn" onclick="closeSystemConfigModal()">&times;</button>
            </div>
            <form id="system-config-form" onsubmit="submitSystemConfig(event)">
                <div class="form-section">
                    <h3>服务器配置</h3>
                    <div class="form-group">
                        <label for="config-host">监听地址</label>
                        <input type="text" id="config-host" required>
                    </div>
                    <div class="form-group">
                        <label for="config-http-port">HTTP 端口</label>
                        <input type="number" id="config-http-port" required min="1" max="65535">
                    </div>
                    <div class="form-group">
                        <label for="config-grpc-port">gRPC 端口</label>
                        <input type="number" id="config-grpc-port" required min="1" max="65535">
                    </div>
                </div>

                <div class="form-section">
                    <h3>数据库配置</h3>
                    <div class="form-group">
                        <label for="config-db-driver">数据库类型</label>
                        <select id="config-db-driver" required onchange="updateDatabaseFields()">
                            <option value="sqlite">SQLite</option>
                            <option value="mysql">MySQL</option>
                            <option value="postgres">PostgreSQL</option>
                        </select>
                    </div>
                    <div class="form-group" id="db-host-group" style="display: none;">
                        <label for="config-db-host">主机地址</label>
                        <input type="text" id="config-db-host">
                    </div>
                    <div class="form-group" id="db-port-group" style="display: none;">
                        <label for="config-db-port">端口</label>
                        <input type="number" id="config-db-port" min="1" max="65535">
                    </div>
                    <div class="form-group" id="db-user-group" style="display: none;">
                        <label for="config-db-user">用户名</label>
                        <input type="text" id="config-db-user">
                    </div>
                    <div class="form-group" id="db-password-group" style="display: none;">
                        <label for="config-db-password">密码</label>
                        <input type="password" id="config-db-password">
                    </div>
                    <div class="form-group">
                        <label for="config-db-name">数据库名称/文件</label>
                        <input type="text" id="config-db-name" required>
                    </div>
                    <div class="form-group" id="db-sslmode-group" style="display: none;">
                        <label for="config-db-sslmode">SSL 模式</label>
                        <select id="config-db-sslmode">
                            <option value="disable">禁用</option>
                            <option value="require">要求</option>
                            <option value="verify-ca">验证 CA</option>
                            <option value="verify-full">完全验证</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-secondary" onclick="testDatabaseConnection()">
                            <i class="fas fa-plug"></i> 测试连接
                        </button>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Elasticsearch 配置</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="config-es-enabled">
                            启用 Elasticsearch
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="config-es-addresses">ES 地址</label>
                        <input type="text" id="config-es-addresses" placeholder="http://localhost:9200">
                    </div>
                    <div class="form-group">
                        <label for="config-es-username">用户名（可选）</label>
                        <input type="text" id="config-es-username">
                    </div>
                    <div class="form-group">
                        <label for="config-es-password">密码（可选）</label>
                        <input type="password" id="config-es-password">
                    </div>
                    <div class="form-group">
                        <label for="config-es-prefix">索引前缀</label>
                        <input type="text" id="config-es-prefix" value="monitor-logs">
                    </div>
                </div>

                <div class="form-section">
                    <h3>监控配置</h3>
                    <div class="form-group">
                        <label for="config-monitor-interval">检查间隔（秒）</label>
                        <input type="number" id="config-monitor-interval" min="10" required>
                    </div>
                    <div class="form-group">
                        <label for="config-monitor-workers">工作线程数</label>
                        <input type="number" id="config-monitor-workers" min="1" required>
                    </div>
                </div>

                <div class="form-section">
                    <h3>日志配置</h3>
                    <div class="form-group">
                        <label for="config-log-level">日志级别</label>
                        <select id="config-log-level" required>
                            <option value="debug">Debug</option>
                            <option value="info">Info</option>
                            <option value="warn">Warning</option>
                            <option value="error">Error</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="config-log-output">输出目标</label>
                        <select id="config-log-output" required>
                            <option value="stdout">标准输出</option>
                            <option value="stderr">标准错误</option>
                            <option value="file">文件</option>
                        </select>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeSystemConfigModal()">取消</button>
                    <button type="submit" class="btn btn-primary">保存配置</button>
                </div>
            </form>
        </div>
    </div>
{{ end }}

{{ define "scripts" }}
    <script src="/static/js/settings.js"></script>
{{ end }}
